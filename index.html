<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Simple Story Writer</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #4f46e5 0%, #9333ea 100%);
            color: #111827;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            line-height: 1.5;
            overflow-x: hidden;
        }
        .container {
            max-width: 100%;
            margin: 10px;
            padding: 12px;
            background: #ffffff;
            border-radius: 8px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        @media (min-width: 768px) {
            .container { max-width: 600px; margin: 20px auto; padding: 16px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
        }
        h1 { text-align: center; font-size: 1.5em; margin-bottom: 10px; }
        @media (min-width: 768px) { h1 { font-size: 2em; } }
        .tabs { display:flex; justify-content:center; gap:6px; margin-bottom:10px; flex-wrap:wrap; }
        .tab-btn { background:#e5e7eb; border:none; padding:6px 12px; cursor:pointer; font-weight:600; border-radius:6px; font-size:0.85em; }
        .tab-btn.active { background:#4f46e5; color:#ffffff; }
        .tab-content { display:none; }
        .tab-content.active { display:block; }
        .editor-section { display:flex; flex-direction:column; gap:10px; }
        .story-editor { background:#f9fafb; border-radius:6px; padding:12px; }
        #story-title { width:100%; font-size:1.1em; padding:8px; border:1px solid #d1d5db; border-radius:6px; margin-bottom:8px; }
        #story-title:focus { border-color:#4f46e5; outline:none; box-shadow:0 0 6px rgba(79,70,229,0.2); }
        .toolbar { display:flex; gap:6px; margin-bottom:8px; flex-wrap:wrap; }
        .toolbar-btn { background:#e5e7eb; border:none; padding:6px 10px; cursor:pointer; border-radius:4px; font-size:0.85em; }
        .toolbar-btn:hover { background:#d1d5db; }
        .page-tabs { display:flex; gap:6px; margin-bottom:8px; flex-wrap:wrap; }
        .page-tab { background:#e5e7eb; border:none; padding:6px 10px; cursor:pointer; border-radius:4px; font-size:0.85em; }
        .page-tab.active { background:#4f46e5; color:#ffffff; }
        .add-page-btn { background:#16a34a; color:#ffffff; border:none; padding:6px 12px; cursor:pointer; border-radius:4px; font-size:0.85em; }
        #story-content { width:100%; min-height:200px; padding:10px; border:1px solid #d1d5db; border-radius:6px; font-size:1em; background:#ffffff; outline:none; resize:vertical; }
        #story-content:focus { box-shadow:0 0 6px rgba(79,70,229,0.2); }
        #word-count { text-align:right; font-size:0.85em; color:#6b7280; margin-top:5px; }
        .notes-section { background:#fef3c7; border-radius:6px; padding:12px; }
        .note { background:#ffffff; border:1px solid #e5e7eb; border-radius:6px; padding:8px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; font-size:0.9em; }
        .delete-note { background:#dc2626; color:#ffffff; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:0.8em; }
        #note-input { width:100%; padding:8px; border:1px solid #d1d5db; border-radius:6px; margin-bottom:8px; font-size:0.9em; }
        .add-note-btn { background:#16a34a; color:#ffffff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; width:100%; font-size:0.9em; }
        .action-buttons { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
        .save-btn, .clear-btn { flex:1; padding:8px; border:none; border-radius:6px; cursor:pointer; font-weight:600; font-size:0.9em; min-width:80px; }
        .save-btn { background:#4f46e5; color:#ffffff; }
        .clear-btn { background:#f59e0b; color:#111827; }
        .saved-stories-section { background:#f9fafb; border-radius:6px; padding:12px; }
        .saved-story-item { background:#ffffff; border:1px solid #e5e7eb; border-radius:6px; padding:8px; margin-bottom:8px; cursor:pointer; font-size:0.9em; display:flex; justify-content:space-between; align-items:center; }
        .delete-saved-story, .load-saved-story { border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:0.8em; }
        .delete-saved-story { background:#dc2626; color:#ffffff; }
        .load-saved-story { background:#16a34a; color:#ffffff; }
        #status-message { text-align:center; margin-top:10px; color:#ffffff; font-size:0.85em; padding:8px; background:rgba(0,0,0,0.4); border-radius:6px; min-height:22px; }
        .dark-mode body { background: linear-gradient(135deg,#1f2937,#4b5563); color:#d1d5db; }
        .dark-mode .container, .dark-mode .story-editor, .dark-mode .notes-section, .dark-mode .saved-stories-section { background:#1f2937; }
        .dark-mode #story-title, .dark-mode #story-content, .dark-mode #note-input { background:#374151; color:#d1d5db; border-color:#4b5563; }
        .dark-mode .toolbar-btn, .dark-mode .page-tab, .dark-mode .tab-btn { background:#4b5563; color:#d1d5db; }
        .dark-mode .page-tab.active, .dark-mode .tab-btn.active { background:#4f46e5; color:#ffffff; }
        .dark-mode .note, .dark-mode .saved-story-item { background:#374151; border-color:#4b5563; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Story Writer</h1>

        <div class="tabs">
            <button id="tab-write" class="tab-btn active" onclick="openTab('editor', this)">Write</button>
            <button id="tab-saved" class="tab-btn" onclick="openTab('saved', this)">Saved Stories</button>
            <button id="tab-dark" class="tab-btn" onclick="toggleDarkMode()">Dark Mode</button>
        </div>

        <div id="editor" class="tab-content active">
            <div class="editor-section">
                <div class="story-editor">
                    <input type="text" id="story-title" placeholder="Story title..." aria-label="Story title">
                    <div class="toolbar">
                        <button class="toolbar-btn" onclick="formatText('bold')" aria-label="Bold"><b>B</b></button>
                        <button class="toolbar-btn" onclick="formatText('italic')" aria-label="Italic"><i>I</i></button>
                        <button class="toolbar-btn" onclick="formatText('underline')" aria-label="Underline"><u>U</u></button>
                        <button class="toolbar-btn" onclick="formatText('insertUnorderedList')" aria-label="Bullet List">â€¢ List</button>
                        <button class="toolbar-btn" onclick="insertLink()" aria-label="Insert Link">Link</button>
                    </div>
                    <div class="page-tabs" id="page-tabs"></div>
                    <button class="add-page-btn" onclick="addPage()">Add Page</button>
                    <div id="story-content" contenteditable="true" aria-label="Story content" spellcheck="true"></div>
                    <div id="word-count">Word count: 0</div>
                    <div class="action-buttons">
                        <button class="save-btn" onclick="saveData()">Save</button>
                        <button class="clear-btn" onclick="clearData()">Clear</button>
                    </div>
                </div>

                <div class="notes-section">
                    <h2>Notes</h2>
                    <div id="notes-list"></div>
                    <input type="text" id="note-input" placeholder="Add a note..." aria-label="Note input">
                    <button class="add-note-btn" onclick="addNote()">Add Note</button>
                </div>
            </div>
        </div>

        <div id="saved" class="tab-content">
            <div class="saved-stories-section">
                <h2>Saved Stories</h2>
                <div id="saved-stories-list"></div>
            </div>
        </div>

        <div id="status-message"></div>
    </div>

    <script>
        // Data structures
        let currentStory = { id: null, title: '', pages: [''], notes: [] };
        let currentPage = 0;
        let stories = JSON.parse(localStorage.getItem('stories') || '[]');
        let darkMode = localStorage.getItem('darkMode') === 'true';
        let statusTimeout = null;

        // Initialization
        window.onload = function() {
            try {
                if (darkMode) document.body.classList.add('dark-mode');
                loadSavedStories();
                renderPageTabs(currentStory.pages.length || 1);
                switchPage(0);
                document.getElementById('story-content').addEventListener('input', updateWordCount);
                // restore draft if exists
                const draft = localStorage.getItem('currentStoryDraft');
                if (draft) {
                    try {
                        currentStory = JSON.parse(draft);
                        if (!Array.isArray(currentStory.pages) || currentStory.pages.length === 0) currentStory.pages = [''];
                        document.getElementById('story-title').value = currentStory.title || '';
                        renderPageTabs(currentStory.pages.length);
                        switchPage(0);
                        loadNotes();
                        showStatus('Draft restored');
                    } catch (e) {
                        // ignore corrupted draft
                    }
                }
                // autosave draft
                setInterval(autoSaveDraft, 30000);
            } catch (err) {
                showStatus('Error starting app: ' + err.message);
            }
        };

        // Saved stories list
        function loadSavedStories() {
            try {
                const list = document.getElementById('saved-stories-list');
                list.innerHTML = '';
                stories.forEach((story, index) => {
                    const item = document.createElement('div');
                    item.className = 'saved-story-item';
                    const titleSpan = document.createElement('span');
                    titleSpan.textContent = `${story.title || 'Untitled'} (${(story.pages && story.pages.length) || 0} pages)`;
                    const controls = document.createElement('div');
                    const loadBtn = document.createElement('button');
                    loadBtn.className = 'load-saved-story';
                    loadBtn.textContent = 'Load';
                    loadBtn.onclick = () => loadSavedStory(index);
                    const delBtn = document.createElement('button');
                    delBtn.className = 'delete-saved-story';
                    delBtn.textContent = 'Delete';
                    delBtn.onclick = () => deleteSavedStory(index);
                    controls.appendChild(loadBtn);
                    controls.appendChild(delBtn);
                    item.appendChild(titleSpan);
                    item.appendChild(controls);
                    list.appendChild(item);
                });
            } catch (err) {
                showStatus('Error loading stories: ' + err.message);
            }
        }

        function loadSavedStory(index) {
            try {
                // deep clone
                currentStory = JSON.parse(JSON.stringify(stories[index]));
                if (!currentStory.pages || currentStory.pages.length === 0) currentStory.pages = [''];
                currentPage = 0;
                document.getElementById('story-title').value = currentStory.title || '';
                renderPageTabs(currentStory.pages.length);
                switchPage(0);
                loadNotes();
                openTab('editor', document.getElementById('tab-write'));
                showStatus('Story loaded!');
            } catch (err) {
                showStatus('Error loading story: ' + err.message);
            }
        }

        function deleteSavedStory(index) {
            if (confirm('Delete this story?')) {
                try {
                    stories.splice(index, 1);
                    saveStories();
                    loadSavedStories();
                    showStatus('Story deleted!');
                } catch (err) {
                    showStatus('Error deleting story: ' + err.message);
                }
            }
        }

        // Save operations
        function saveData() {
            try {
                currentStory.title = document.getElementById('story-title').value.trim();
                if (!currentStory.title) {
                    showStatus('Please enter a title.');
                    return;
                }
                saveCurrentPage();
                // if no id, assign one
                if (!currentStory.id) currentStory.id = Date.now();
                const existingIndex = stories.findIndex(s => s.id === currentStory.id || (s.title === currentStory.title && s.pages.length === currentStory.pages.length));
                if (existingIndex > -1) {
                    stories[existingIndex] = JSON.parse(JSON.stringify(currentStory));
                } else {
                    stories.push(JSON.parse(JSON.stringify(currentStory)));
                }
                const data = JSON.stringify(stories);
                // localStorage limit check (approx)
                if (data.length > 4 * 1024 * 1024) {
                    showStatus('Storage limit reached. Delete some stories.');
                    return;
                }
                saveStories();
                loadSavedStories();
                // save draft as well
                localStorage.setItem('currentStoryDraft', JSON.stringify(currentStory));
                showStatus('Story saved!');
            } catch (err) {
                showStatus('Error saving story: ' + err.message);
            }
        }

        function autoSaveDraft() {
            try {
                // don't autosave empty things
                saveCurrentPage();
                if (currentStory.title || (currentStory.pages && currentStory.pages.some(p => p && p.trim()))) {
                    localStorage.setItem('currentStoryDraft', JSON.stringify(currentStory));
                    showStatus('Draft autosaved');
                }
            } catch (err) {
                // silent
            }
        }

        function saveStories() {
            localStorage.setItem('stories', JSON.stringify(stories));
        }

        // Page tabs
        function renderPageTabs(numPages) {
            try {
                if (!numPages || numPages < 1) numPages = 1;
                const pageTabs = document.getElementById('page-tabs');
                pageTabs.innerHTML = '';
                for (let i = 0; i < numPages; i++) {
                    const tab = document.createElement('button');
                    tab.className = 'page-tab';
                    tab.textContent = `Page ${i + 1}`;
                    tab.onclick = () => switchPage(i);
                    pageTabs.appendChild(tab);
                }
                // ensure currentPage in bounds
                if (currentPage >= numPages) currentPage = numPages - 1;
                // add active class
                const children = pageTabs.children;
                for (let i = 0; i < children.length; i++) {
                    children[i].classList.toggle('active', i === currentPage);
                }
            } catch (err) {
                showStatus('Error rendering pages: ' + err.message);
            }
        }

        function switchPage(pageIndex) {
            try {
                saveCurrentPage();
                currentPage = pageIndex;
                if (!currentStory.pages || currentStory.pages.length === 0) currentStory.pages = [''];
                document.getElementById('story-content').innerHTML = currentStory.pages[pageIndex] || '';
                document.querySelectorAll('.page-tab').forEach((tab, i) => tab.classList.toggle('active', i === pageIndex));
                updateWordCount();
            } catch (err) {
                showStatus('Error switching page: ' + err.message);
            }
        }

        function addPage() {
            try {
                saveCurrentPage();
                currentStory.pages.push('');
                renderPageTabs(currentStory.pages.length);
                switchPage(currentStory.pages.length - 1);
            } catch (err) {
                showStatus('Error adding page: ' + err.message);
            }
        }

        function saveCurrentPage() {
            try {
                // ensure pages exist
                if (!currentStory.pages) currentStory.pages = [''];
                currentStory.pages[currentPage] = document.getElementById('story-content').innerHTML;
            } catch (err) {
                showStatus('Error saving page: ' + err.message);
            }
        }

        // Notes (use unique IDs and safe DOM insertion)
        function loadNotes() {
            try {
                const notesList = document.getElementById('notes-list');
                notesList.innerHTML = '';
                (currentStory.notes || []).forEach(note => addNoteElement(note));
            } catch (err) {
                showStatus('Error loading notes: ' + err.message);
            }
        }

        function addNote() {
            try {
                const noteInput = document.getElementById('note-input');
                const noteText = noteInput.value.trim();
                if (!noteText) return;
                const note = { id: Date.now() + Math.floor(Math.random() * 1000), text: noteText };
                if (!currentStory.notes) currentStory.notes = [];
                currentStory.notes.push(note);
                addNoteElement(note);
                noteInput.value = '';
                // persist draft
                localStorage.setItem('currentStoryDraft', JSON.stringify(currentStory));
            } catch (err) {
                showStatus('Error adding note: ' + err.message);
            }
        }

        function addNoteElement(note) {
            try {
                const notesList = document.getElementById('notes-list');
                const noteDiv = document.createElement('div');
                noteDiv.className = 'note';
                const span = document.createElement('span');
                span.textContent = note.text;
                const delBtn = document.createElement('button');
                delBtn.className = 'delete-note';
                delBtn.textContent = 'Delete';
                delBtn.onclick = () => deleteNote(note.id, noteDiv);
                noteDiv.appendChild(span);
                noteDiv.appendChild(delBtn);
                notesList.appendChild(noteDiv);
            } catch (err) {
                showStatus('Error adding note element: ' + err.message);
            }
        }

        function deleteNote(id, el) {
            try {
                if (!currentStory.notes) return;
                currentStory.notes = currentStory.notes.filter(n => n.id !== id);
                if (el && el.parentElement) el.parentElement.removeChild(el);
                // update draft
                localStorage.setItem('currentStoryDraft', JSON.stringify(currentStory));
            } catch (err) {
                showStatus('Error deleting note: ' + err.message);
            }
        }

        // Tabs
        function openTab(tabName, el) {
            try {
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                const target = document.getElementById(tabName);
                if (target) target.classList.add('active');
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                if (el && el.classList) el.classList.add('active');
            } catch (err) {
                showStatus('Error switching tab: ' + err.message);
            }
        }

        // Formatting (execCommand fallback)
        function formatText(command) {
            try {
                // execCommand is deprecated but still widely supported; keep for now
                document.execCommand(command, false, null);
            } catch (err) {
                showStatus('Error formatting text: ' + err.message);
            }
        }

        function insertLink() {
            try {
                const url = prompt('Enter URL (e.g., https://example.com):');
                if (url && /^https?:\/\/\S+$/.test(url)) {
                    document.execCommand('createLink', false, url);
                } else {
                    showStatus('Invalid or empty URL.');
                }
            } catch (err) {
                showStatus('Error inserting link: ' + err.message);
            }
        }

        // Word count
        function updateWordCount() {
            try {
                const text = document.getElementById('story-content').innerText.replace(/\s+/g, ' ').trim();
                const count = text.length > 0 ? text.split(' ').length : 0;
                document.getElementById('word-count').textContent = `Word count: ${count}`;
            } catch (err) {
                showStatus('Error updating word count: ' + err.message);
            }
        }

        // Clear current story
        function clearData() {
            if (confirm('Clear current story?')) {
                try {
                    currentStory = { id: null, title: '', pages: [''], notes: [] };
                    document.getElementById('story-title').value = '';
                    document.getElementById('story-content').innerHTML = '';
                    document.getElementById('notes-list').innerHTML = '';
                    renderPageTabs(1);
                    currentPage = 0;
                    updateWordCount();
                    // remove draft
                    localStorage.removeItem('currentStoryDraft');
                    showStatus('Story cleared!');
                } catch (err) {
                    showStatus('Error clearing story: ' + err.message);
                }
            }
        }

        // Dark mode
        function toggleDarkMode() {
            try {
                darkMode = !darkMode;
                document.body.classList.toggle('dark-mode', darkMode);
                localStorage.setItem('darkMode', darkMode);
                // update button active state visually
                const darkBtn = document.getElementById('tab-dark');
                if (darkBtn) darkBtn.classList.toggle('active', darkMode);
            } catch (err) {
                showStatus('Error toggling dark mode: ' + err.message);
            }
        }

        // Status messages (clear previous timer)
        function showStatus(message) {
            const status = document.getElementById('status-message');
            status.textContent = message;
            if (statusTimeout) clearTimeout(statusTimeout);
            statusTimeout = setTimeout(() => {
                status.textContent = '';
            }, 3000);
        }
    </script>
</body>
</html>
